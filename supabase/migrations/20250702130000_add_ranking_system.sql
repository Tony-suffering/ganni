-- =============================================
-- „É©„É≥„Ç≠„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆüË£Ö
-- ‰ΩúÊàêÊó•: 2025-07-02
-- Ê¶ÇË¶Å: „É¶„Éº„Ç∂„Éº„É©„É≥„Ç≠„É≥„Ç∞Ê©üËÉΩ„Å®„Ç≠„É£„ÉÉ„Ç∑„É•„Ç∑„Çπ„ÉÜ„É†„ÇíËøΩÂä†
-- =============================================

-- 1. „É©„É≥„Ç≠„É≥„Ç∞„Ç≠„É£„ÉÉ„Ç∑„É•„ÉÜ„Éº„Éñ„É´
CREATE TABLE ranking_cache (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    
    -- „É©„É≥„Ç≠„É≥„Ç∞Á®ÆÂà•
    ranking_type VARCHAR(50) NOT NULL, -- 'total_points', 'learning_points', 'influence_points', 'photo_quality', 'post_count'
    
    -- ÊúüÈñìË®≠ÂÆö
    period VARCHAR(20) NOT NULL, -- 'all_time', 'monthly', 'weekly', 'daily'
    
    -- „É©„É≥„Ç≠„É≥„Ç∞ÊÉÖÂ†±
    rank_position INTEGER NOT NULL,
    score DECIMAL(10,2) NOT NULL,
    
    -- „É°„Çø„Éá„Éº„Çø
    metadata JSONB, -- ËøΩÂä†ÊÉÖÂ†±ÔºàÂπ≥Âùá„Çπ„Ç≥„Ç¢„ÄÅÊäïÁ®øÊï∞„Å™„Å©Ôºâ
    
    -- „Çø„Ç§„É†„Çπ„Çø„É≥„Éó
    calculated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
    
    -- „É¶„Éã„Éº„ÇØÂà∂Á¥Ñ
    UNIQUE(user_id, ranking_type, period)
);

-- „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
CREATE INDEX idx_ranking_cache_type_period ON ranking_cache(ranking_type, period);
CREATE INDEX idx_ranking_cache_position ON ranking_cache(ranking_type, period, rank_position);
CREATE INDEX idx_ranking_cache_user_id ON ranking_cache(user_id);
CREATE INDEX idx_ranking_cache_calculated_at ON ranking_cache(calculated_at);

-- RLSË®≠ÂÆö
ALTER TABLE ranking_cache ENABLE ROW LEVEL SECURITY;

-- ÂÖ®„É¶„Éº„Ç∂„Éº„Åå„É©„É≥„Ç≠„É≥„Ç∞ÊÉÖÂ†±„ÇíÈñ≤Ë¶ßÂèØËÉΩ
CREATE POLICY "Anyone can view rankings" ON ranking_cache
    FOR SELECT USING (true);

-- 2. „É©„É≥„Ç≠„É≥„Ç∞Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´
CREATE TABLE ranking_history (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    ranking_type VARCHAR(50) NOT NULL,
    period VARCHAR(20) NOT NULL,
    rank_date DATE NOT NULL,
    rank_position INTEGER NOT NULL,
    score DECIMAL(10,2) NOT NULL,
    rank_change INTEGER DEFAULT 0, -- ÂâçÂõû„Åã„Çâ„ÅÆÈ†Ü‰ΩçÂ§âÂãï
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ΩúÊàê
CREATE INDEX idx_ranking_history_user_date ON ranking_history(user_id, rank_date);
CREATE INDEX idx_ranking_history_type_date ON ranking_history(ranking_type, period, rank_date);

-- RLSË®≠ÂÆö
ALTER TABLE ranking_history ENABLE ROW LEVEL SECURITY;

-- „É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆÂ±•Ê≠¥„ÅÆ„ÅøÈñ≤Ë¶ßÂèØËÉΩ
CREATE POLICY "Users can view own ranking history" ON ranking_history
    FOR SELECT USING (auth.uid() = user_id);

-- 3. Á∑èÂêà„Éù„Ç§„É≥„Éà„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞Èñ¢Êï∞
CREATE OR REPLACE FUNCTION update_total_points_ranking(p_period TEXT DEFAULT 'all_time')
RETURNS VOID AS $$
DECLARE
    r RECORD;
    rank_pos INTEGER := 1;
BEGIN
    -- Êó¢Â≠ò„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂâäÈô§
    DELETE FROM ranking_cache 
    WHERE ranking_type = 'total_points' AND period = p_period;
    
    -- Á∑èÂêà„Éù„Ç§„É≥„Éà„Åß„É©„É≥„Ç≠„É≥„Ç∞‰ΩúÊàê
    FOR r IN (
        SELECT 
            up.user_id,
            up.total_points as score,
            jsonb_build_object(
                'learning_points', up.learning_points,
                'influence_points', up.influence_points,
                'level', up.level
            ) as metadata
        FROM user_points up
        ORDER BY up.total_points DESC
    ) LOOP
        INSERT INTO ranking_cache (
            user_id, 
            ranking_type, 
            period, 
            rank_position, 
            score, 
            metadata
        ) VALUES (
            r.user_id, 
            'total_points', 
            p_period, 
            rank_pos, 
            r.score, 
            r.metadata
        );
        
        rank_pos := rank_pos + 1;
    END LOOP;
    
    RAISE NOTICE '‚úÖ Total points ranking updated for period: %', p_period;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 4. ÂÜôÁúüÂìÅË≥™„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞Èñ¢Êï∞
CREATE OR REPLACE FUNCTION update_photo_quality_ranking(p_period TEXT DEFAULT 'all_time')
RETURNS VOID AS $$
DECLARE
    r RECORD;
    rank_pos INTEGER := 1;
BEGIN
    -- Êó¢Â≠ò„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂâäÈô§
    DELETE FROM ranking_cache 
    WHERE ranking_type = 'photo_quality' AND period = p_period;
    
    -- ÂÜôÁúüÂìÅË≥™„Åß„É©„É≥„Ç≠„É≥„Ç∞‰ΩúÊàêÔºàÂπ≥Âùá„Çπ„Ç≥„Ç¢ÔºãÊäïÁ®øÊï∞„ÅÆÈáç„Åø‰ªò„ÅëÔºâ
    FOR r IN (
        SELECT 
            ups.user_id,
            (ups.average_photo_score * LOG(GREATEST(ups.total_posts, 1) + 1)) as score,
            jsonb_build_object(
                'average_score', ups.average_photo_score,
                'highest_score', ups.highest_photo_score,
                'total_posts', ups.total_posts
            ) as metadata
        FROM user_post_stats ups
        WHERE ups.total_posts > 0 AND ups.average_photo_score > 0
        ORDER BY (ups.average_photo_score * LOG(GREATEST(ups.total_posts, 1) + 1)) DESC
    ) LOOP
        INSERT INTO ranking_cache (
            user_id, 
            ranking_type, 
            period, 
            rank_position, 
            score, 
            metadata
        ) VALUES (
            r.user_id, 
            'photo_quality', 
            p_period, 
            rank_pos, 
            r.score, 
            r.metadata
        );
        
        rank_pos := rank_pos + 1;
    END LOOP;
    
    RAISE NOTICE '‚úÖ Photo quality ranking updated for period: %', p_period;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 5. ÊäïÁ®øÊï∞„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞Èñ¢Êï∞
CREATE OR REPLACE FUNCTION update_post_count_ranking(p_period TEXT DEFAULT 'all_time')
RETURNS VOID AS $$
DECLARE
    r RECORD;
    rank_pos INTEGER := 1;
    date_filter TEXT;
BEGIN
    -- ÊúüÈñì„Å´Âøú„Åò„ÅüÊó•‰ªò„Éï„Ç£„É´„Çø„Éº
    CASE p_period
        WHEN 'weekly' THEN date_filter := 'AND p.created_at >= CURRENT_DATE - INTERVAL ''7 days''';
        WHEN 'monthly' THEN date_filter := 'AND p.created_at >= DATE_TRUNC(''month'', CURRENT_DATE)';
        ELSE date_filter := '';
    END CASE;
    
    -- Êó¢Â≠ò„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂâäÈô§
    DELETE FROM ranking_cache 
    WHERE ranking_type = 'post_count' AND period = p_period;
    
    -- ÂãïÁöÑ„ÇØ„Ç®„É™„ÅßÊäïÁ®øÊï∞„É©„É≥„Ç≠„É≥„Ç∞‰ΩúÊàê
    FOR r IN EXECUTE format('
        SELECT 
            p.user_id,
            COUNT(*) as score,
            jsonb_build_object(
                ''post_count'', COUNT(*),
                ''avg_photo_score'', COALESCE(AVG(p.photo_score), 0),
                ''total_likes'', COALESCE(SUM(p.likes_count), 0)
            ) as metadata
        FROM posts p
        WHERE 1=1 %s
        GROUP BY p.user_id
        HAVING COUNT(*) > 0
        ORDER BY COUNT(*) DESC
    ', date_filter) LOOP
        INSERT INTO ranking_cache (
            user_id, 
            ranking_type, 
            period, 
            rank_position, 
            score, 
            metadata
        ) VALUES (
            r.user_id, 
            'post_count', 
            p_period, 
            rank_pos, 
            r.score, 
            r.metadata
        );
        
        rank_pos := rank_pos + 1;
    END LOOP;
    
    RAISE NOTICE '‚úÖ Post count ranking updated for period: %', p_period;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 6. „Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥ÂΩ±ÈüøÂäõ„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞Èñ¢Êï∞
CREATE OR REPLACE FUNCTION update_inspiration_ranking(p_period TEXT DEFAULT 'all_time')
RETURNS VOID AS $$
DECLARE
    r RECORD;
    rank_pos INTEGER := 1;
BEGIN
    -- Êó¢Â≠ò„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂâäÈô§
    DELETE FROM ranking_cache 
    WHERE ranking_type = 'inspiration_influence' AND period = p_period;
    
    -- „Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥ÂΩ±ÈüøÂäõ„Åß„É©„É≥„Ç≠„É≥„Ç∞‰ΩúÊàê
    FOR r IN (
        SELECT 
            uis.user_id,
            (uis.inspiration_given_count * 2 + uis.inspiration_received_count + uis.max_chain_level * 5) as score,
            jsonb_build_object(
                'inspiration_given', uis.inspiration_given_count,
                'inspiration_received', uis.inspiration_received_count,
                'max_chain_level', uis.max_chain_level,
                'streak_days', uis.streak_days
            ) as metadata
        FROM user_inspiration_stats uis
        WHERE uis.inspiration_given_count > 0 OR uis.inspiration_received_count > 0
        ORDER BY (uis.inspiration_given_count * 2 + uis.inspiration_received_count + uis.max_chain_level * 5) DESC
    ) LOOP
        INSERT INTO ranking_cache (
            user_id, 
            ranking_type, 
            period, 
            rank_position, 
            score, 
            metadata
        ) VALUES (
            r.user_id, 
            'inspiration_influence', 
            p_period, 
            rank_pos, 
            r.score, 
            r.metadata
        );
        
        rank_pos := rank_pos + 1;
    END LOOP;
    
    RAISE NOTICE '‚úÖ Inspiration influence ranking updated for period: %', p_period;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 7. ÂÖ®„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞Èñ¢Êï∞
CREATE OR REPLACE FUNCTION update_all_rankings()
RETURNS VOID AS $$
BEGIN
    -- ÂÖ®ÊúüÈñì„É©„É≥„Ç≠„É≥„Ç∞
    PERFORM update_total_points_ranking('all_time');
    PERFORM update_photo_quality_ranking('all_time');
    PERFORM update_post_count_ranking('all_time');
    PERFORM update_inspiration_ranking('all_time');
    
    -- ÊúàÈñì„É©„É≥„Ç≠„É≥„Ç∞
    PERFORM update_post_count_ranking('monthly');
    
    -- ÈÄ±Èñì„É©„É≥„Ç≠„É≥„Ç∞
    PERFORM update_post_count_ranking('weekly');
    
    RAISE NOTICE 'üèÜ All rankings updated successfully';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 8. „É¶„Éº„Ç∂„Éº„É©„É≥„Ç≠„É≥„Ç∞ÊÉÖÂ†±ÂèñÂæóÈñ¢Êï∞
CREATE OR REPLACE FUNCTION get_user_ranking_info(p_user_id UUID)
RETURNS TABLE(
    ranking_type TEXT,
    period TEXT,
    rank_position INTEGER,
    score DECIMAL(10,2),
    total_users INTEGER,
    metadata JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        rc.ranking_type::TEXT,
        rc.period::TEXT,
        rc.rank_position,
        rc.score,
        (SELECT COUNT(*) FROM ranking_cache rc2 
         WHERE rc2.ranking_type = rc.ranking_type 
         AND rc2.period = rc.period)::INTEGER as total_users,
        rc.metadata
    FROM ranking_cache rc
    WHERE rc.user_id = p_user_id
    ORDER BY 
        CASE rc.ranking_type 
            WHEN 'total_points' THEN 1
            WHEN 'photo_quality' THEN 2  
            WHEN 'post_count' THEN 3
            WHEN 'inspiration_influence' THEN 4
        END,
        CASE rc.period
            WHEN 'all_time' THEN 1
            WHEN 'monthly' THEN 2
            WHEN 'weekly' THEN 3
        END;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 9. „Éà„ÉÉ„Éó„É©„É≥„Ç´„ÉºÂèñÂæóÈñ¢Êï∞
CREATE OR REPLACE FUNCTION get_top_rankers(
    p_ranking_type TEXT DEFAULT 'total_points',
    p_period TEXT DEFAULT 'all_time',
    p_limit INTEGER DEFAULT 10
)
RETURNS TABLE(
    rank_position INTEGER,
    user_id UUID,
    score DECIMAL(10,2),
    metadata JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        rc.rank_position,
        rc.user_id,
        rc.score,
        rc.metadata
    FROM ranking_cache rc
    WHERE rc.ranking_type = p_ranking_type 
    AND rc.period = p_period
    ORDER BY rc.rank_position
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 10. „É©„É≥„Ç≠„É≥„Ç∞Â±•Ê≠¥Ë®òÈå≤Èñ¢Êï∞
CREATE OR REPLACE FUNCTION record_ranking_history()
RETURNS VOID AS $$
DECLARE
    r RECORD;
    prev_rank INTEGER;
    rank_change INTEGER;
BEGIN
    -- ‰ªäÊó•„ÅÆÊó•‰ªò
    FOR r IN (
        SELECT 
            user_id,
            ranking_type,
            period,
            rank_position,
            score
        FROM ranking_cache
        WHERE ranking_type = 'total_points' AND period = 'all_time'
    ) LOOP
        -- ÂâçÂõû„ÅÆÈ†Ü‰Ωç„ÇíÂèñÂæó
        SELECT rank_position INTO prev_rank
        FROM ranking_history
        WHERE user_id = r.user_id 
        AND ranking_type = r.ranking_type 
        AND period = r.period
        ORDER BY rank_date DESC
        LIMIT 1;
        
        -- È†Ü‰ΩçÂ§âÂãï„ÇíË®àÁÆó
        rank_change := COALESCE(prev_rank - r.rank_position, 0);
        
        -- Â±•Ê≠¥„Å´Ë®òÈå≤
        INSERT INTO ranking_history (
            user_id,
            ranking_type,
            period,
            rank_date,
            rank_position,
            score,
            rank_change
        ) VALUES (
            r.user_id,
            r.ranking_type,
            r.period,
            CURRENT_DATE,
            r.rank_position,
            r.score,
            rank_change
        ) ON CONFLICT (user_id, ranking_type, period, rank_date) 
        DO UPDATE SET
            rank_position = EXCLUDED.rank_position,
            score = EXCLUDED.score,
            rank_change = EXCLUDED.rank_change;
    END LOOP;
    
    RAISE NOTICE 'üìä Ranking history recorded for date: %', CURRENT_DATE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 11. ÂàùÊúü„É©„É≥„Ç≠„É≥„Ç∞Ë®àÁÆóÂÆüË°å
SELECT update_all_rankings();

-- 12. ÂÆöÊúüÂÆüË°åÁî®„ÅÆCRONË®≠ÂÆöÔºàÊâãÂãï„Åß„ÇÇÂÆüË°åÂèØËÉΩÔºâ
-- Ê≥®ÊÑè: Supabase„Åß„ÅØÊâãÂãï„ÅßCRON job„ÇíË®≠ÂÆö„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô
-- ‰ª•‰∏ã„ÅØÂèÇËÄÉ‰æã„Åß„ÅôÔºàÂÆüÈöõ„ÅÆÁí∞Â¢É„Åß„ÅØÈÅ©Âàá„Å™ÊñπÊ≥ï„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ

-- Êó•Ê¨°ÂÆüË°åÁî®„Ç≥„É°„É≥„Éà:
-- SELECT cron.schedule('daily-ranking-update', '0 2 * * *', 'SELECT update_all_rankings();');
-- SELECT cron.schedule('daily-ranking-history', '0 3 * * *', 'SELECT record_ranking_history();');

-- „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏
DO $$
BEGIN
    RAISE NOTICE 'üèÜ „É©„É≥„Ç≠„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü';
    RAISE NOTICE 'üìä ÂÆüË£Ö„Åï„Çå„Åü„É©„É≥„Ç≠„É≥„Ç∞:';
    RAISE NOTICE '   - Á∑èÂêà„Éù„Ç§„É≥„Éà„É©„É≥„Ç≠„É≥„Ç∞';
    RAISE NOTICE '   - ÂÜôÁúüÂìÅË≥™„É©„É≥„Ç≠„É≥„Ç∞ÔºàÂπ≥Âùá„Çπ„Ç≥„Ç¢√óÊäïÁ®øÊï∞Èáç„ÅøÔºâ';
    RAISE NOTICE '   - ÊäïÁ®øÊï∞„É©„É≥„Ç≠„É≥„Ç∞ÔºàÂÖ®ÊúüÈñì/ÊúàÈñì/ÈÄ±ÈñìÔºâ';
    RAISE NOTICE '   - „Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥ÂΩ±ÈüøÂäõ„É©„É≥„Ç≠„É≥„Ç∞';
    RAISE NOTICE 'üîÑ „É©„É≥„Ç≠„É≥„Ç∞„ÅØ‰ª•‰∏ã„ÅÆÈñ¢Êï∞„ÅßÊõ¥Êñ∞ÂèØËÉΩ:';
    RAISE NOTICE '   - SELECT update_all_rankings(); -- ÂÖ®„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞';
    RAISE NOTICE '   - SELECT get_user_ranking_info(''„É¶„Éº„Ç∂„ÉºID''); -- ÂÄã‰∫∫„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó';
    RAISE NOTICE '   - SELECT get_top_rankers(''total_points'', ''all_time'', 10); -- „Éà„ÉÉ„Éó10ÂèñÂæó';
END $$;