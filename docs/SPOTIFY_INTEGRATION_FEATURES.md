# Spotify API 連携機能仕様書

## 概要

Airport Moments BlogにSpotify APIを統合し、写真と音楽を組み合わせた新しいユーザー体験を提供します。

## 実装済み機能

### 1. Spotify OAuth認証
- Spotify OAuth 2.0による安全な認証フロー
- アクセストークンとリフレッシュトークンの管理
- Supabaseでのトークン永続化

### 2. 音楽プロファイル分析
- ユーザーの音楽傾向から性格を分析
  - 音楽パーソナリティ（エナジェティック、ポジティブ、メランコリック等）
  - エネルギーレベル（高・中・低）
  - 主な気分の傾向
- よく聴く曲のトップ5表示
- 音楽の好みに基づいた推薦

### 3. 写真と音楽のムードシンク
- 投稿写真の雰囲気を分析
- 写真の雰囲気に合う楽曲を自動推薦
- 感情パラメータに基づいたマッチング

## 技術仕様

### 環境変数
```env
VITE_SPOTIFY_CLIENT_ID=your_client_id
VITE_SPOTIFY_CLIENT_SECRET=your_client_secret
VITE_SPOTIFY_REDIRECT_URI=https://your-domain.com/auth/spotify
```

### データベーステーブル
```sql
user_spotify_tokens
- id: UUID (PK)
- user_id: UUID (FK to profiles)
- access_token: TEXT
- refresh_token: TEXT
- expires_at: TIMESTAMP
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 主要コンポーネント
- `SpotifyService`: Spotify API通信を管理
- `SpotifyIntegration`: 連携状態と音楽プロファイル表示
- `SpotifyMoodSync`: 写真と音楽のマッチング
- `SpotifyCallback`: OAuth認証コールバック処理

## 今後の拡張案

### フェーズ1: 投稿機能の強化
1. **投稿時のBGM推薦**
   - 写真アップロード時に自動でBGM候補を提案
   - 投稿にSpotifyトラックを埋め込み
   - 音楽付き投稿の特別バッジ

2. **音楽メタデータの活用**
   - 楽曲のテンポと写真の動きをマッチング
   - 歌詞の感情分析と写真の雰囲気を連動
   - アーティスト情報と撮影地の文化的関連付け

### フェーズ2: ソーシャル機能
1. **音楽趣味マッチング**
   - 同じアーティストが好きなユーザーを発見
   - 音楽ジャンル別のコミュニティ形成
   - 共通の音楽趣味度スコア表示

2. **協調プレイリスト**
   - ユーザー同士で共有プレイリスト作成
   - 空港ごとの人気プレイリスト
   - 季節や時間帯に応じた自動プレイリスト

### フェーズ3: 高度な分析
1. **音楽×写真AI分析**
   - 音楽のムードと写真の構図の相関分析
   - 最適な音楽×写真の組み合わせ学習
   - パーソナライズされた創作アドバイス

2. **トレンド分析**
   - 音楽トレンドと写真スタイルの相関
   - 地域別の音楽×写真文化マップ
   - 時系列での好みの変化追跡

### フェーズ4: 収益化機能
1. **Spotifyプレミアム連携**
   - プレミアムユーザー限定機能
   - 高音質プレビュー
   - オフライン同期

2. **音楽NFT連携**
   - 写真×音楽のNFT作成
   - 限定楽曲へのアクセス権
   - アーティストコラボレーション

## API使用制限と注意点

### レート制限
- Spotify Web API: 1秒あたり最大10リクエスト
- 認証トークン: 1時間有効
- リフレッシュトークン: 無期限（ただし未使用で6ヶ月後失効）

### プライバシー配慮
- ユーザーの音楽履歴は本人のみ閲覧可能
- 音楽プロファイルの公開/非公開設定
- GDPR準拠のデータ削除機能

### セキュリティ
- Client Secretは環境変数で管理
- HTTPSでの通信必須
- CSRFトークンによる認証保護

## 実装優先度

1. **高優先度**
   - 投稿時のBGM推薦機能
   - 音楽趣味の可視化
   - プレイリスト自動生成

2. **中優先度**
   - ソーシャルマッチング
   - 高度な分析機能
   - 地域別プレイリスト

3. **低優先度**
   - NFT連携
   - 有料機能
   - アーティストコラボ

## メトリクス

### 成功指標
- Spotify連携率: 30%以上
- 音楽付き投稿率: 連携ユーザーの50%以上
- 平均セッション時間: 20%向上

### 追跡項目
- 連携ユーザー数
- 音楽推薦のクリック率
- プレイリスト作成数
- 音楽×写真投稿のエンゲージメント率

## 更新履歴

- 2025-07-03: 初回実装（認証、プロファイル表示、ムードシンク）
- 今後: 投稿時BGM推薦機能の追加予定