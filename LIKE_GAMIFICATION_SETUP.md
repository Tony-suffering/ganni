# いいね機能ゲーミフィケーション統合 - セットアップガイド

## 📋 実装内容

いいね機能とポイントシステムを連携させ、以下の機能を追加しました：

### ✅ 実装済み機能

1. **ポイント付与システム**
   - いいね送信: +1 IP (Influence Points)
   - いいね受信: +2 LP (Learning Points)
   - 自分の投稿への自いいねは対象外

2. **活動ログ追跡**
   - 日次のいいね送信/受信数を記録
   - アクティビティスコア計算に反映

3. **いいね削除時のポイント処理**
   - いいね取り消し時のポイント減少
   - 適切なポイント履歴記録

4. **リアルタイム通知**
   - いいね時のポイント獲得通知
   - アニメーション付きの視覚的フィードバック

## 🚀 セットアップ手順

### 1. データベースマイグレーション実行

以下のマイグレーションファイルをSupabaseダッシュボードで実行してください：

```bash
supabase/migrations/20250702140000_add_like_gamification.sql
```

または、Supabaseダッシュボードの SQL エディタで直接実行：

1. Supabaseダッシュボードにログイン
2. プロジェクト選択 → SQL エディタ
3. `20250702140000_add_like_gamification.sql` の内容をコピー&ペースト
4. 実行ボタンをクリック

### 2. 動作確認

#### A. ブラウザコンソールでのテスト

1. アプリケーションにログイン
2. F12でデベロッパーツールを開く
3. Console タブで `TEST_LIKE_GAMIFICATION.js` の内容を実行

#### B. 手動テスト

1. 他のユーザーの投稿にいいねする
2. ポイント通知が表示されることを確認
3. ダッシュボードでポイントが増加していることを確認
4. いいねを取り消してポイントが減少することを確認

## 📊 期待される動作

### ポイント付与
- **いいね送信者**: +1 IP
- **いいね受信者**: +2 LP
- **ポイント履歴**: `point_history` テーブルに記録
- **活動ログ**: `daily_activity_logs` テーブルに記録

### 通知システム
- いいね時にリアルタイムでポイント通知表示
- 3秒後に自動で非表示
- アニメーション付きの滑らかな表示

### データベーストリガー
1. `trigger_update_like_activity_logs`: 活動ログ更新
2. `trigger_award_like_points`: ポイント付与
3. `trigger_handle_like_removal`: いいね削除時の処理

## 🔧 トラブルシューティング

### 1. ポイントが付与されない場合

```sql
-- トリガーの存在確認
SELECT trigger_name, event_manipulation, action_timing, table_name
FROM information_schema.triggers 
WHERE trigger_name LIKE '%like%'
ORDER BY trigger_name;
```

### 2. 権限エラーが発生する場合

```sql
-- 関数の権限確認
SELECT routine_name, routine_type, security_type
FROM information_schema.routines
WHERE routine_name IN ('update_like_activity_logs', 'award_like_points', 'handle_like_removal');
```

### 3. リアルタイム通知が表示されない場合

- ブラウザコンソールで `🔄 ポイント履歴のリアルタイム更新を開始` メッセージを確認
- `point_history` テーブルへのリアルタイム接続を確認
- Supabaseのリアルタイム機能が有効になっているか確認

## 📝 データベース構造

### 新規追加されるデータ

#### point_history テーブル
```sql
-- いいね関連のsource_type
- 'like_given': いいね送信
- 'like_received': いいね受信  
- 'like_removed': いいね削除
```

#### daily_activity_logs テーブル
```sql
-- 追跡される活動
- likes_given: 送信したいいね数
- likes_received: 受信したいいね数
```

## 🎯 パフォーマンス考慮事項

1. **バッチ処理**: 大量の既存データがある場合は段階的に処理
2. **インデックス**: `likes` テーブルに適切なインデックスが設定済み
3. **リアルタイム**: ユーザー固有のフィルタリングで効率的な更新

## 📈 今後の拡張可能性

1. **連続いいねボーナス**: 連続でいいねした場合の追加ポイント
2. **いいね返しボーナス**: 相互いいねのボーナス
3. **時間帯ボーナス**: 特定時間のいいねに追加ポイント
4. **品質ボーナス**: 高品質投稿へのいいねに追加ポイント

## ✅ 完了チェックリスト

- [ ] マイグレーション実行
- [ ] トリガー動作確認
- [ ] フロントエンド通知動作確認
- [ ] ポイント履歴記録確認
- [ ] 活動ログ更新確認
- [ ] いいね削除時の処理確認

すべての項目が完了すれば、いいね機能のゲーミフィケーション統合は正常に動作します。